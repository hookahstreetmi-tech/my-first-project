# Концепция и план реализации системы "Джарвис" (Indus.8M)

Цель — создать единый автономный организм, где воркфлоу обмениваются данными через центральную базу знаний (Supabase) и управляются логикой состояний.

## Архитектура: "Машина Состояний"

Система уходит от линейного выполнения к событийной модели.
*   **Мозг (Supabase):** Единый источник правды. Хранит состояние каждого проекта и все накопленные данные.
*   **Оркестратор (Qualifizer):** Диспетчер, который проверяет состояние проектов и переключает рубильник запуска агентов.
*   **Агенты (Research, Content, Analysis):** Исполнительный слой. Получают задачу, выполняют её и молча сохраняют результат в БД, обновляя статус.

---

## Основные компоненты и изменения

### 1. Единый Хаб Памяти (Supabase)
Вместо разрозненных передач JSON-ов между вебхуками, все данные пишутся в строгие таблицы.

**Структура БД:**
*   **`projects`** — Таблица-менеджер.
    *   `status`: `new` -> `researching` -> `analyzing` -> `generating` -> `review` -> `done`.
    *   `query`: Исходная задача пользователя.
*   **`research_logs`** — "Сырая" память.
    *   Сюда агенты сваливают все находки с Perplexity, Google, Telegram.
*   **`artifacts`** — Чистовики.
    *   Сгенерированные гипотезы, посты и планы, готовые к показу пользователю.

### 2. Qualifizer (Оркестратор)
Становится "умным маршрутизатором".
*   **Логика:** При любом сообщении пользователя или по таймеру проверяет таблицу `projects`.
*   **Сценарии:**
    *   *Есть проект в статусе `researching`?* -> Проверить логи. Если готовы, переключить на `analyzing`.
    *   *Есть проект в статусе `review`?* -> Показать пользователю кнопки "Одобрить/Правки".
    *   *Новый запрос?* -> Создать запись в `projects` и запустить первичный ресерч.

### 3. Research Team (Генератор Знаний)
Превращается в автономный цикл.
*   **Вход:** ID проекта + поисковый запрос.
*   **Цикл (Loop):**
    1.  Поиск информации (Perplexity).
    2.  Запись в `research_logs`.
    3.  **Самоанализ (Query Refiner):** LLM читает найденное и решает: "Мне нужно больше данных?"
        *   *Да:* Генерирует новый запрос -> Повтор шага 1.
        *   *Нет:* Ставит галочку "Готово" (обновляет статус проекта).

---

## Пошаговый план разработки

### Этап 1: Фундамент (База Данных)
*   Создать таблицы `projects`, `research_logs`, `artifacts` в Supabase.
*   Настроить RLS (политики безопасности) для доступа n8n.

### Этап 2: "Мозг" и "Глаза" (Оркестрация и Ресерч)
*   **Qualifizer Update:**
    *   Добавить ноды чтения Supabase (`Get Active Project`).
    *   Внедрить `Switch` ноду для маршрутизации по статусу проекта.
*   **Research Team Update:**
    *   Отключить "прямой" ответ пользователю.
    *   Настроить запись в `research_logs`.
    *   Реализовать цикл доуточнения информации (Loop over items).

### Этап 3: Интерфейс и Завершение (Content & Review)
*   Модифицировать генераторы контента (SMM, Copywriter) на чтение из `research_logs`.
*   Настроить отправку готовых `artifacts` в Telegram через Qualifizer с кнопками управления.

### Этап 4: Автономность (Topic Generator)
*   Настроить запуск по расписанию.
*   Агент сам ищет тренды, создает запись в `projects` (статус `new`) и спрашивает пользователя: "Нашел тему X. Работаем?"

---

## Верификация
1.  **Тест базы:** Ручное создание проекта в SQL -> Проверка реакции Qualifizer.
2.  **Тест цикла ресерча:** Запуск агента -> Проверка, что в базе появилось 3-5 записей с разным контентом по одной теме.
3.  **Финальный прогон:** Запрос "Сделай анализ рынка X" -> Получение готового отчета без промежуточных "Ок, ищу..." каждые 5 секунд.
